
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>A Hierarchical model for Rugby prediction &#8212; PyMC3 3.3 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bayesian Survival Analysis" href="survival_analysis.html" />
    <link rel="prev" title="Probabilistic Matrix Factorization for Making Personalized Recommendations" href="probabilistic_matrix_factorization.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="A-Hierarchical-model-for-Rugby-prediction">
<h1>A Hierarchical model for Rugby prediction<a class="headerlink" href="#A-Hierarchical-model-for-Rugby-prediction" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>&#64;Author: Peadar Coyle</li>
<li>&#64;email: <a class="reference external" href="mailto:peadarcoyle&#37;&#52;&#48;googlemail&#46;com">peadarcoyle<span>&#64;</span>googlemail<span>&#46;</span>com</a></li>
<li>&#64;date: 31/12/15 updated 29/12/2017</li>
</ul>
<p>I came across the following blog post on <a class="reference external" href="http://danielweitzenfeld.github.io/passtheroc/blog/2014/10/28/bayes-premier-league/">Daniel
Weitzenfeld’s</a>
blog, based on the work of <a class="reference external" href="http://discovery.ucl.ac.uk/16040/1/16040.pdf">Baio and
Blangiardo</a>.</p>
<p>In this example, we’re going to reproduce the first model described in
the paper using PyMC3.</p>
<p>Since I am a rugby fan I decide to apply the results of the paper to the
Six Nations Championship, which is a competition between Italy, Ireland,
Scotland, England, France and Wales.</p>
<div class="section" id="Motivation">
<h2>Motivation<a class="headerlink" href="#Motivation" title="Permalink to this headline">¶</a></h2>
<p>Your estimate of the strength of a team depends on your estimates of the
other strengths</p>
<p>Ireland are a stronger team than Italy for example - but by how much?</p>
<p>Source for Results 2014 are Wikipedia. I’ve added the subsequent years,
2015, 2016, 2017. Manually pulled from Wikipedia.</p>
<ul class="simple">
<li>We want to infer a latent parameter - that is the ‘strength’ of a
team based only on their <strong>scoring intensity</strong>, and all we have are
their scores and results, we can’t accurately measure the ‘strength’
of a team.</li>
<li>Probabilistic Programming is a brilliant paradigm for modeling these
<strong>latent</strong> parameters</li>
<li>Aim is to build a model for the upcoming Six Nations in 2018.</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">!</span>date

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="kn">as</span> <span class="nn">pm</span><span class="o">,</span> <span class="nn">theano.tensor</span> <span class="kn">as</span> <span class="nn">tt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">StrMethodFormatter</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Sat Jan 13 16:41:34 UTC 2018
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
/opt/conda/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
</pre></div></div>
</div>
<p>This is a Rugby prediction exercise. So we’ll input some data. We’ve
taken this from Wikipedia and BBC sports.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/rugby.csv&#39;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;rugby.csv&#39;</span><span class="p">))</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="What-do-we-want-to-infer?">
<h2>What do we want to infer?<a class="headerlink" href="#What-do-we-want-to-infer?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We want to infer the latent paremeters (every team’s strength) that
are generating the data we observe (the scorelines).</li>
<li>Moreover, we know that the scorelines are a noisy measurement of team
strength, so ideally, we want a model that makes it easy to quantify
our uncertainty about the underlying strengths.</li>
<li>Often we don’t know what the Bayesian Model is explicitly, so we have
to ‘estimate’ the Bayesian Model’</li>
<li>If we can’t solve something, approximate it.</li>
<li>Markov-Chain Monte Carlo (MCMC) instead draws samples from the
posterior.</li>
<li>Fortunately, this algorithm can be applied to almost any model.</li>
</ul>
</div>
<div class="section" id="What-do-we-want?">
<h2>What do we want?<a class="headerlink" href="#What-do-we-want?" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We want to quantify our uncertainty</li>
<li>We want to also use this to generate a model</li>
<li>We want the answers as distributions not point estimates</li>
</ul>
<div class="section" id="Visualization/EDA">
<h3>Visualization/EDA<a class="headerlink" href="#Visualization/EDA" title="Permalink to this headline">¶</a></h3>
<p>We should do some some exploratory data analysis of this dataset.</p>
<p>The plots should be fairly self-explantory, we’ll look at things like
difference between teams in terms of their scores.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>home_score</th>
      <th>away_score</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>60.000000</td>
      <td>60.000000</td>
      <td>60.000000</td>
      <td>60.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>29.500000</td>
      <td>23.500000</td>
      <td>19.983333</td>
      <td>2015.500000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>17.464249</td>
      <td>14.019962</td>
      <td>12.911028</td>
      <td>1.127469</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>2014.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>14.750000</td>
      <td>16.000000</td>
      <td>10.000000</td>
      <td>2014.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>29.500000</td>
      <td>20.500000</td>
      <td>18.000000</td>
      <td>2015.500000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>44.250000</td>
      <td>27.250000</td>
      <td>23.250000</td>
      <td>2016.250000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>59.000000</td>
      <td>67.000000</td>
      <td>63.000000</td>
      <td>2017.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Let&#39;s look at the tail end of this dataframe</span>
<span class="n">df_all</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>home_team</th>
      <th>away_team</th>
      <th>home_score</th>
      <th>away_score</th>
      <th>year</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>55</th>
      <td>55</td>
      <td>Italy</td>
      <td>France</td>
      <td>18</td>
      <td>40</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>56</th>
      <td>56</td>
      <td>England</td>
      <td>Scotland</td>
      <td>61</td>
      <td>21</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>57</th>
      <td>57</td>
      <td>Scotland</td>
      <td>Italy</td>
      <td>29</td>
      <td>0</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>58</th>
      <td>58</td>
      <td>France</td>
      <td>Wales</td>
      <td>20</td>
      <td>18</td>
      <td>2017</td>
    </tr>
    <tr>
      <th>59</th>
      <td>59</td>
      <td>Ireland</td>
      <td>England</td>
      <td>13</td>
      <td>9</td>
      <td>2017</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>There are a few things here that we don’t need. We don’t need the year
for our model. But that is something that could improve a future model.</p>
<p>Firstly let us look at differences in scores by year.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;difference&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;home_score&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;away_score&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;difference&#39;</span><span class="p">]</span>
      <span class="o">.</span><span class="n">mean</span><span class="p">()</span>

      <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Average magnitude of scores difference Six Nations&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">df_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;difference&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
      <span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average (abs) point difference&#39;</span><span class="p">));</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_12_0.png" src="../_images/notebooks_rugby_analytics_12_0.png" />
</div>
</div>
<p>We can see that the standard error is large. So we can’t say anything
about the differences. Let’s look country by country.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;difference_non_abs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;home_score&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;away_score&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let us first loook at a Pivot table with a sum of this, broken down by
year.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_all</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;difference_non_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>year</th>
      <th>2014</th>
      <th>2015</th>
      <th>2016</th>
      <th>2017</th>
    </tr>
    <tr>
      <th>home_team</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>England</th>
      <td>7.000000</td>
      <td>20.666667</td>
      <td>7.500000</td>
      <td>21.333333</td>
    </tr>
    <tr>
      <th>France</th>
      <td>6.666667</td>
      <td>0.000000</td>
      <td>-2.333333</td>
      <td>4.000000</td>
    </tr>
    <tr>
      <th>Ireland</th>
      <td>28.000000</td>
      <td>8.500000</td>
      <td>17.666667</td>
      <td>7.000000</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>-21.000000</td>
      <td>-31.000000</td>
      <td>-23.500000</td>
      <td>-33.666667</td>
    </tr>
    <tr>
      <th>Scotland</th>
      <td>-11.000000</td>
      <td>-12.000000</td>
      <td>2.500000</td>
      <td>16.666667</td>
    </tr>
    <tr>
      <th>Wales</th>
      <td>25.666667</td>
      <td>1.000000</td>
      <td>22.000000</td>
      <td>4.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Now let’s first plot this by home team without year.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;difference_non_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;home_team&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;Home_Team&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score difference Home team and away team&#39;</span><span class="p">)</span>
<span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_18_0.png" src="../_images/notebooks_rugby_analytics_18_0.png" />
</div>
</div>
<p>You can see that Italy and Scotland have negative scores on average. You
can also see that England, Ireland and Wales have been the strongest
teams lately at home.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;difference_non_abs&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s2">&quot;Away_Team&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Score difference Home team and away team&#39;</span><span class="p">)</span>
<span class="p">);</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_20_0.png" src="../_images/notebooks_rugby_analytics_20_0.png" />
</div>
</div>
<p>This indicates that Italy, Scotland and France all have poor away from
home form. England suffers the least when playing away from home. This
aggregate view doesn’t take into account the strength of the teams.</p>
<p>Let us look a bit more at a timeseries plot of the average of the score
difference over the year.</p>
<p>We see some changes in team behaviour, and we also see that Italy is a
poor team.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df_all</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;home_team&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;difference_non_abs&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Score Difference&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_23_0.png" src="../_images/notebooks_rugby_analytics_23_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">df_all</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;away_team&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;difference_non_abs&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Score Difference&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_24_0.png" src="../_images/notebooks_rugby_analytics_24_0.png" />
</div>
</div>
<p>You can see some interesting things here like Wales were good away from
home in 2015. In that year they won three games away from home and won
by 40 points or so away from home to Italy.</p>
<p>So now we’ve got a feel for the data, we can proceed on with describing
the model.</p>
</div>
<div class="section" id="What-assumptions-do-we-know-for-our-'generative-story'?">
<h3>What assumptions do we know for our ‘generative story’?<a class="headerlink" href="#What-assumptions-do-we-know-for-our-'generative-story'?" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>We know that the Six Nations in Rugby only has 6 teams - they each
play each other once</li>
<li>We have data from the last few years</li>
<li>We also know that in sports scoring is modelled as a Poisson
distribution</li>
<li>We consider home advantage to be a strong effect in sports</li>
</ul>
</div>
</div>
<div class="section" id="The-model.">
<h2>The model.<a class="headerlink" href="#The-model." title="Permalink to this headline">¶</a></h2>
<p>The league is made up by a total of T= 6 teams, playing each other once
in a season. We indicate the number of points scored by the home and the
away team in the g-th game of the season (15 games) as <span class="math">\(y_{g1}\)</span>
and <span class="math">\(y_{g2}\)</span> respectively.</p>
</p><p>The vector of observed counts <span class="math">\(\mathbb{y} = (y_{g1}, y_{g2})\)</span> is
modelled as independent Poisson:
<span class="math">\(y_{gi}| \theta_{gj} \tilde\;\;  Poisson(\theta_{gj})\)</span> where the
theta parameters represent the scoring intensity in the g-th game for
the team playing at home (j=1) and away (j=2), respectively.</p>
</p><p>We model these parameters according to a formulation that has been used
widely in the statistical literature, assuming a log-linear random
effect model:</p>
<div class="math">
\[log \theta_{g1} = home + att_{h(g)} + def_{a(g)}\]</div>
<div class="math">
\[log \theta_{g2} = att_{a(g)} + def_{h(g)}\]</div>
<ul class="simple">
<li>The parameter home represents the advantage for the team hosting the
game and we assume that this effect is constant for all the teams and
throughout the season</li>
<li>The scoring intensity is determined jointly by the attack and defense
ability of the two teams involved, represented by the parameters att
and def, respectively</li>
<li>Conversely, for each t = 1, …, T, the team-specific effects are
modelled as exchangeable from a common distribution:</li>
<li><span class="math">\(att_{t} \; \tilde\;\; Normal(\mu_{att},\tau_{att})\)</span> and
<span class="math">\(def_{t} \; \tilde\;\;Normal(\mu_{def},\tau_{def})\)</span></li>
</ul>
<p>We restrict to only the useful columns for this model.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_all</span><span class="p">[[</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="s1">&#39;home_score&#39;</span><span class="p">,</span> <span class="s1">&#39;away_score&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">teams</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_team</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">teams</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">teams</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;team&#39;</span><span class="p">])</span>
<span class="n">teams</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">index</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;home_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_home&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">teams</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;away_team&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;i_away&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">observed_home_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">home_score</span><span class="o">.</span><span class="n">values</span>
<span class="n">observed_away_goals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">values</span>

<span class="n">home_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">values</span>
<span class="n">away_team</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">i_away</span><span class="o">.</span><span class="n">values</span>

<span class="n">num_teams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">i_home</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">num_games</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">home_team</span><span class="p">)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_away&#39;</span><span class="p">)</span>
<span class="n">att_starting_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;i_home&#39;</span><span class="p">)</span>
<span class="n">def_starting_points</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">away_score</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>We did some munging above and adjustments of the data to make it
<strong>tidier</strong> for our model.</li>
<li>The log function to away scores and home scores is a standard trick
in the sports analytics literature</li>
</ul>
</div>
<div class="section" id="Building-of-the-model">
<h2>Building of the model<a class="headerlink" href="#Building-of-the-model" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>We now build the model in PyMC3, specifying the global parameters,
and the team-specific parameters and the likelihood function</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="c1"># global model parameters</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Flat</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)</span>
    <span class="n">sd_att</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfStudentT</span><span class="p">(</span><span class="s1">&#39;sd_att&#39;</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">sd_def</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">HalfStudentT</span><span class="p">(</span><span class="s1">&#39;sd_def&#39;</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Flat</span><span class="p">(</span><span class="s1">&#39;intercept&#39;</span><span class="p">)</span>

    <span class="c1"># team-specific model parameters</span>
    <span class="n">atts_star</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;atts_star&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd_att</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span>
    <span class="n">defs_star</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s2">&quot;defs_star&quot;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sd_def</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">num_teams</span><span class="p">)</span>

    <span class="n">atts</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;atts&#39;</span><span class="p">,</span> <span class="n">atts_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">atts_star</span><span class="p">))</span>
    <span class="n">defs</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s1">&#39;defs&#39;</span><span class="p">,</span> <span class="n">defs_star</span> <span class="o">-</span> <span class="n">tt</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">defs_star</span><span class="p">))</span>
    <span class="n">home_theta</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">home</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">home_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">away_team</span><span class="p">])</span>
    <span class="n">away_theta</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="n">away_team</span><span class="p">]</span> <span class="o">+</span> <span class="n">defs</span><span class="p">[</span><span class="n">home_team</span><span class="p">])</span>

    <span class="c1"># likelihood of observed data</span>
    <span class="n">home_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;home_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">home_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_home_goals</span><span class="p">)</span>
    <span class="n">away_points</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Poisson</span><span class="p">(</span><span class="s1">&#39;away_points&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">away_theta</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">observed_away_goals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<ul class="simple">
<li>We specified the model and the likelihood function</li>
<li>All this runs on a Theano graph under the hood</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pm</span><span class="o">.</span><span class="n">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
/opt/conda/lib/python3.6/site-packages/pymc3/model.py:384: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  if not np.issubdtype(var.dtype, float):
Multiprocess sampling (3 chains in 3 jobs)
NUTS: [defs_star, atts_star, intercept, sd_def_log__, sd_att_log__, home]
100%|██████████| 2000/2000 [00:29&lt;00:00, 68.07it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_35_1.png" src="../_images/notebooks_rugby_analytics_35_1.png" />
</div>
</div>
<p>Let us apply good <em>statistical workflow</em> practices and look at the
various evaluation metrics to see if our NUTS sampler converged.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">bfmi</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">bfmi</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
<span class="n">max_gr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gr_stats</span><span class="p">)</span> <span class="k">for</span> <span class="n">gr_stats</span> <span class="ow">in</span> <span class="n">pm</span><span class="o">.</span><span class="n">gelman_rubin</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">energyplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
   <span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;BFMI = {}</span><span class="se">\n</span><span class="s2">Gelman-Rubin = {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bfmi</span><span class="p">,</span> <span class="n">max_gr</span><span class="p">)));</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_38_0.png" src="../_images/notebooks_rugby_analytics_38_0.png" />
</div>
</div>
<p>Our model has converged well and the Gelman-Rubin statistic looks good.</p>
<p>Let us look at some of the stats, just to verify that our model has
returned the correct attributes. We can see that some teams are stronger
than others. This is what we would expect with attack</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[19]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>array([[ 0.08968587,  0.24789199],
       [-0.17169411,  0.00788836],
       [ 0.02725114,  0.18826695],
       [-0.20606871, -0.02168828],
       [-0.44769868, -0.22706935],
       [ 0.1813111 ,  0.34262147]])
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">])[</span><span class="mi">50</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[20]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>array([ 0.17179028, -0.08393033,  0.10807495, -0.115689  , -0.33455323,
        0.25632191])
</pre></div>
</div>
</div>
</div>
<div class="section" id="Results">
<h2>Results<a class="headerlink" href="#Results" title="Permalink to this headline">¶</a></h2>
<p>From the above we can start to understand the different distributions of
attacking strength and defensive strength. These are probabilistic
estimates and help us better understand the uncertainty in sports
analytics</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_hpd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">]),</span>
                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hpd_low&#39;</span><span class="p">,</span> <span class="s1">&#39;hpd_high&#39;</span><span class="p">],</span>
                      <span class="n">index</span><span class="o">=</span><span class="n">teams</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">df_median</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">quantiles</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">])[</span><span class="mi">50</span><span class="p">],</span>
                         <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hpd_median&#39;</span><span class="p">],</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">teams</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">df_hpd</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_median</span><span class="p">)</span>
<span class="n">df_hpd</span><span class="p">[</span><span class="s1">&#39;relative_lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">hpd_median</span> <span class="o">-</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">hpd_low</span>
<span class="n">df_hpd</span><span class="p">[</span><span class="s1">&#39;relative_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">hpd_high</span> <span class="o">-</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">hpd_median</span>
<span class="n">df_hpd</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;hpd_median&#39;</span><span class="p">)</span>
<span class="n">df_hpd</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_hpd</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">df_hpd</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">df_hpd</span><span class="o">.</span><span class="n">hpd_median</span><span class="p">,</span>
             <span class="n">yerr</span><span class="o">=</span><span class="p">(</span><span class="n">df_hpd</span><span class="p">[[</span><span class="s1">&#39;relative_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;relative_upper&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
             <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;HPD of Attack Strength, by Team&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Team&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Posterior Attack Strength&#39;</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">df_hpd</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df_hpd</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_44_0.png" src="../_images/notebooks_rugby_analytics_44_0.png" />
</div>
</div>
<p>This is one of the powerful things about Bayesian modelling, we can have
<em>uncertainty quantification</em> of some of our estimates. We’ve got a
Bayesian credible interval for the attack strength of different
countries.</p>
<p>We can see an overlap between Ireland, Wales and England which is what
you’d expect since these teams have won in recent years.</p>
<p>Italy is well behind everyone else - which is what we’d expect and
there’s an overlap between Scotland and France which seems about right.</p>
<p>There are probably some effects we’d like to add in here, like weighting
more recent results more strongly. However that’d be a much more
complicated model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">teams</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">values</span>
<span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;atts&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Offense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[22]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.gridspec.GridSpec at 0x7fbac5cefb70&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_46_1.png" src="../_images/notebooks_rugby_analytics_46_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">forestplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;defs&#39;</span><span class="p">],</span> <span class="n">ylabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s2">&quot;Team Defense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[23]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.gridspec.GridSpec at 0x7fbad0b11908&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_47_1.png" src="../_images/notebooks_rugby_analytics_47_1.png" />
</div>
</div>
<p>Good teams like Ireland and England have a strong negative effect
defense. Which is what we expect. We expect our strong teams to have
strong positive effects in attack and strong negative effects in
defense.</p>
<p>This approach that we’re using of looking at parameters and examining
them is part of a good statistical workflow. We also think that perhaps
our priors could be better specified. However this is beyond the scope
of this article. We recommend for a good discussion of ‘statistical
workflow’ you visit <a class="reference external" href="http://mc-stan.org/users/documentation/case-studies/rstan_workflow.html">Robust Statistical Workflow with
RStan</a></p>
<p>Let’s do some other plots. So we can see our range for our defensive
effect. I’ll print the teams below too just for reference</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">teams</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>team</th>
      <th>i</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Wales</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>France</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Ireland</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Scotland</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Italy</td>
      <td>4</td>
    </tr>
    <tr>
      <th>5</th>
      <td>England</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">pm</span><span class="o">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;defs&#39;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_52_0.png" src="../_images/notebooks_rugby_analytics_52_0.png" />
</div>
</div>
<p>We know Ireland is defs_2 so let’s talk about that one. We can see that
it’s mean is -0.39 which means we expect Ireland to have a strong
defense. Which is what we’d expect, Ireland generally even in games it
loses doesn’t lose by say 50 points. And we can see that the 95% HPD is
between -0.491, and -0.28</p>
<p>In comparison with Italy, we see a strong positive effect 0.58 mean and
a HPD of 0.51 and 0.65. This means that we’d expect Italy to concede a
lot of points, compared to what it scores. Given that Italy often loses
by 30 - 60 points, this seems correct.</p>
<p>We see here also that this informs what other priors we could bring into
this. We could bring some sort of world ranking as a prior.</p>
<p>As of December 2017 the <a class="reference external" href="https://www.worldrugby.org/rankings/mru">rugby
rankings</a> indicate that
England is 2nd in the world, Ireland 3rd, Scotland 5th, Wales 7th,
France 9th and Italy 14th. We could bring that into a model and it can
explain some of the fact that Italy is apart from a lot of the other
teams.</p>
<p>Now let’s simulate who wins over 1000 seasons.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">pp_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_ppc</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="stderr output_area docutils container">
<div class="highlight"><pre>
100%|██████████| 1000/1000 [00:01&lt;00:00, 823.05it/s]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">home_sim_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sim_points_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">home_won</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">home_won</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pp_trace</span><span class="p">[</span><span class="s1">&#39;home_points&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pp_trace</span><span class="p">[</span><span class="s1">&#39;away_points&#39;</span><span class="p">])</span>
<span class="p">})</span>
<span class="n">home_sim_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;home_team&#39;</span><span class="p">])</span>

<span class="n">away_sim_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;sim_points_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">away_won</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">away_won</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pp_trace</span><span class="p">[</span><span class="s1">&#39;home_points&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pp_trace</span><span class="p">[</span><span class="s1">&#39;away_points&#39;</span><span class="p">])</span>
<span class="p">})</span>
<span class="n">away_sim_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;away_team&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">sim_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">home_sim_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">away_sim_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)</span>
                                        <span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                        <span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;team&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;team&#39;</span><span class="p">)</span>
                        <span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">sim_table</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>rank</th>
      <th>1.0</th>
      <th>2.0</th>
      <th>3.0</th>
      <th>4.0</th>
      <th>5.0</th>
      <th>6.0</th>
    </tr>
    <tr>
      <th>team</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>England</th>
      <td>0.464</td>
      <td>0.428</td>
      <td>0.108</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>France</th>
      <td>0.000</td>
      <td>0.002</td>
      <td>0.029</td>
      <td>0.912</td>
      <td>0.057</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>Ireland</th>
      <td>0.627</td>
      <td>0.293</td>
      <td>0.079</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>Italy</th>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.002</td>
      <td>0.998</td>
    </tr>
    <tr>
      <th>Scotland</th>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.127</td>
      <td>0.873</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>Wales</th>
      <td>0.077</td>
      <td>0.255</td>
      <td>0.658</td>
      <td>0.010</td>
      <td>0.000</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sim_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">StrMethodFormatter</span><span class="p">(</span><span class="s1">&#39;{x:.1%}&#39;</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Probability of finishing with the most points</span><span class="se">\n</span><span class="s2">(including ties)&quot;</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Team&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_59_0.png" src="../_images/notebooks_rugby_analytics_59_0.png" />
</div>
</div>
<p>We see according to this model that Ireland finishes with the most
points about 60% of the time, and England finishes with the most points
45% of the time and Wales finishes with the most points about 10% of the
time. (Note that these probabilities do not sum to 100% since there is a
non-zero chance of a tie atop the table.) As an Irish rugby fan - I like
this model. However it indicates some problems with shrinkage, and bias.
Since recent form suggests England will win. Nevertheless the point of
this model was to illustrate how a Hierachical model could be applied to
a sports analytics problem, and illustrate the power of PyMC3.</p>
</div>
<div class="section" id="Covariates">
<h2>Covariates<a class="headerlink" href="#Covariates" title="Permalink to this headline">¶</a></h2>
<p>We should do some exploration of the variables</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">df_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">trace_to_dataframe</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">teams</span><span class="o">.</span><span class="n">team</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[34]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>array([&#39;Wales&#39;, &#39;France&#39;, &#39;Ireland&#39;, &#39;Scotland&#39;, &#39;Italy&#39;, &#39;England&#39;],
      dtype=object)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>

<span class="n">cols</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;atts_star__0&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_wales&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__1&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_france&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__2&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_ireland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__3&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_scotland&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__4&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_italy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atts_star__5&#39;</span><span class="p">:</span> <span class="s1">&#39;atts_star_england&#39;</span>
<span class="p">}</span>

<span class="n">df_trace_att</span> <span class="o">=</span> <span class="n">df_trace</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df_trace_att</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_rugby_analytics_64_0.png" src="../_images/notebooks_rugby_analytics_64_0.png" />
</div>
</div>
<p>We observe that there isn’t a lot of correlation between these
covariates, other than the weaker teams like Italy have a more negative
distribution of these variables. Nevertheless this is a good method to
get some insight into how the variables are behaving.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pymc3_logo.jpg" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">PyMC3</a></h1>



<p class="blurb">Probabilistic Programming in Python: Bayesian Modeling and Probabilistic Machine Learning with Theano</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prob_dists.html">Probability Distributions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#howto">Howto</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#applied">Applied</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BEST.html">Bayesian Estimation Supersedes the T-Test</a></li>
<li class="toctree-l3"><a class="reference internal" href="multilevel_modeling.html">A Primer on Bayesian Methods for Multilevel Modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="stochastic_volatility.html">Stochastic Volatility model</a></li>
<li class="toctree-l3"><a class="reference internal" href="probabilistic_matrix_factorization.html">Probabilistic Matrix Factorization for Making Personalized Recommendations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">A Hierarchical model for Rugby prediction</a></li>
<li class="toctree-l3"><a class="reference internal" href="survival_analysis.html">Bayesian Survival Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="dawid-skene.html">The Dawid-Skene model with priors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#glm">GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#gaussian-processes">Gaussian Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#mixture-models">Mixture Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#variational-inference">Variational Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#stochastic-gradient">Stochastic Gradient</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, The PyMC Development Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/notebooks/rugby_analytics.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>